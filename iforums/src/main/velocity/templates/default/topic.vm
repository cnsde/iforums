#parse("/templates/$!{templateName}/inc/header.vm")

#set($canEditSomeMessage = false)

<script type="text/javascript" src="${contextPath}/templates/${templateName}/js/jquery.js?${startupTime}"></script>
<script type="text/javascript" src="${contextPath}/templates/${templateName}/js/jquery.jeditable.pack.js?${startupTime}"></script>
<script type="text/javascript" src="${contextPath}/templates/${templateName}/js/post_show.js?${startupTime}"></script>
<script type="text/javascript" src="${contextPath}/templates/${templateName}/js/post.js?${startupTime}"></script>
<script type="text/javascript" src="${contextPath}/templates/${templateName}/js/pagination.js?${startupTime}"></script>
<style type="text/css">@import url( ${contextPath}/templates/${templateName}/styles/SyntaxHighlighter.css?${startupTime} );</style>
#if($logged)
	<script type="text/javascript" src="${contextPath}/templates/${templateName}/js/watch.js?${startupTime}"></script>
#end

<script type="text/javascript">
<!--
<#include "js/karma.js">
<#include "js/utils.js"/>

#if($canRemove || $isModerator || $isAdmin)
	function confirmDelete(postId)
	{
		if (confirm("${I18n.getMessage("Moderation.ConfirmPostDelete")}")) {
			var reason = prompt("${I18n.getMessage("ModerationLog.changeReason")}");

			if (reason == null || reason == "") {
				alert("${I18n.getMessage("ModerationLog.reasonIsEmpty")}");
				return false;
			}
			else {
				var link = document.getElementById("delete" + postId);
				link.href += "&log_description=" + encodeURIComponent(reason) + "&log_type=1";
			}

			return true;
		}
		
		return false;
	}
#end

-->
</script>
<script type="text/javascript">
	var  tempid="";
	function newCaptcha(id)
	{
		document.getElementById("captcha_img"+id).src = "${contextPath}/jforum${extension}?module=captcha&action=generate&timestamp=" + new Date();
	}	

	function activateQuickReply(id)
	{
		if(tempid==""){
			$("#captcha_img"+id).attr("src", "${contextPath}/captcha/generate/"+new Date()+".html");
			$("#quickReply"+id).slideToggle('slow', function() {
					//window.scrollBy(0, 1000);
			});
		}else{
			if(tempid==id){
				$("#quickReply"+id).slideToggle('slow', function() {
					//window.scrollBy(0, 1000);
				});
				tempid ="";
				return;
			}else{
				$("#captcha_img"+id).attr("src", "${contextPath}/captcha/generate/"+new Date()+".html");
				$("#quickReply"+tempid).slideToggle('slow', function() {
					//window.scrollBy(0, 1000);
				});		
				$("#quickReply"+id).slideToggle('slow', function() {
					//window.scrollBy(0, 1000);
				});
			}
		}
		tempid = id;
	}
	
	function validatePostForm(f)
	{
		if (f.message.value.replace(/^\s*|\s*$/g, "").length == 0) {
			alert("${I18n.getMessage("PostForm.textEmpty")}");
			f.message.focus();
		
			return false;
		}
	
		$("#icon_saving").css("display", "inline");
		$("#btnSubmit").attr("disabled", "disabled").val("${I18n.getMessage("PostForm.saving")}...");
	
		return true;
	}
	-->
</script>
#if($moderator)
	<script type="text/JavaScript" src="/js/list/moderation")}"></script>
#end
<div id="nav">
	<span class="nav">
	<a class="nav" href="${contextPath}/index.html")}">${I18n.getMessage("ForumListing.forumIndex")} </a> 
	&raquo; <a class="nav" href="${contextPath}/forum-${forum.id}.html")}">${forum.name} </a></span>
	&raquo;<span class="maintitle"><a href="${contextPath}/topic-${topic.id}.html")}" name="top" class="maintitle" id="top">${topic.title}</a></span>
</div>

<DIV class=pages_btns>
	<div class="pages">
		<a href="/forums/show/${forum.id}")}" class="next"> &lsaquo;&lsaquo; ${forum.name}</a>
	</div>
	${paginationData}
	<SPAN class=postbtn id="newtopic" onmouseover="$('newtopic').id = 'newtopictmp';this.id = 'newtopic';showMenu(this.id);">
		<A href="/jforum${extension}?module=posts&amp;action=insert&amp;forum_id=${forum.id}", "")}">
			<IMG src="${contextPath}/templates/${templateName}/images/newtopic.gif" border=0>
		</A>
	</SPAN>
	#if(!$readonly && $topic.status != 1)
		<SPAN class=replybtn><A href="javascript:replyTopic();">
			<a href="/posts/reply/${start}/${topic.id}")}" rel="nofollow" class="icon_reply nav">
				<IMG alt="Reply" src="${contextPath}/templates/${templateName}/images/reply.gif" border=0>
			</a>
		</SPAN>
	#end
</DIV>

<div id="headfilter">
<ul class="tabs">
    #if($logged)
		#if($bookmarksEnabled)
			<li><a href="javascript:addBookmark(2, ${topic.id});">${I18n.getMessage("Bookmarks.addTo")}</a></li>
		#end
	
		#if(!$watching)
			<li><a href="#watch" onClick="watchTopic('/posts/watch/${start}/${topic.id}")}', '${I18n.getMessage("PostShow.confirmWatch")}');">
				<#set($watchMessage = $I18n.getMessage("PostShow.watch"))
		#else
			<li><a href="/posts/unwatch/${start}/${topic.id}")}">$I18n.getMessage("PostShow.unwatch")
		#end
		${watchMessage}</a><li>
	#end
	#if($isModerator || $isAdmin)
			<form action="/jforum")}" method="post" name="formModeration" id="formModeration">
			<input type="hidden" name="action" value="doModeration" />
			<input type="hidden" name="module" value="moderation" />
			<input type="hidden" name="returnUrl" value="/${moduleName}/${action}/${start}/${topic.id}")}" />
			<input type="hidden" name="forum_id" value="${topic.forumId}" />
			<input type="hidden" name="topic_id" value="${topic.id}" />
			<input type="hidden" name="log_type" value="0"/>
			<input type="hidden" name="log_description">
			<input type="hidden" id="moderationTodo" />
			<@presentation.moderationImages/>
			</form>
	#end
	#if($rssEnabled)
		<li style="border: medium none ;"><a href="${contextPath}/rss/topicPosts/${topic.id}${extension}"><img src="${contextPath}/templates/${templateName}/images/xml_button.gif" border="0" alt="XML" /></a></li>
	#end
</ul>
</div>

#set($isShowPoll = 0)
#foreach($post in $posts)
#set($canEditCurrentMessage = ($post.canEdit && $topic.status != 1) || $moderatorCanEdit)
<DIV class="mainbox viewtopic">
	#if($post_index == 0)
		<SPAN class=headactions>
  		</SPAN>
		<H1>${forum.name}</H1>
	#end
	<TABLE id="rid0" cellSpacing=0 cellPadding=0>
		  <TBODY>
		  <TR>
		    <TD class=postauthor rowspan="3">
		      #set($user = $post.user)
		      #parse("/templates/$!{templateName}/inc/postShowUser.vm")
		      #parse("/templates/$!{templateName}/inc/postShowUserProfile.vm")
			</TD>
		    <TD class=postdetail>
		      <DIV class=postinfo><STRONG title="ID:0">${velocityCount}<SUP>#</SUP></STRONG> 
				  #if($post.editTime)
					  $!dt.format("yyyy年MM月dd日 hh:mm:ss",${post.editTime})&nbsp;
				  #end
			 	  #if($post.userIp&& $isModerator)
					 ${I18n.getMessage("PostShow.userIP")}:${post.userIp}
				  #end
			  </DIV>
			  #set($useSignature = ($user.attachSignatureEnabled && $user.signature&& $user.signature.length() > 0 && $post.isSignatureEnabled()))
		      <DIV class="postcontent">
		      <DIV id="content_0" class=contentmsg>
			  #if (($isShowPoll==0)&&($poll)))
				  #set($isShowPoll = 1)
			      <table cellspacing="1" cellpadding="3" border="0">
							<tr>
								<td colspan="2"><b>${I18n.getMessage("PostShow.pollTitle")}</b>:${poll.label}</td>
							</tr>
							<tr>
								<td class="row1" colspan="2" align="center">
									#if($poll.open && $canVoteOnPoll)
										<form action="/jforum")}" method="post">
											<input type="hidden" name="action" value="vote" />
											<input type="hidden" name="module" value="${moduleName}" />
											<input type="hidden" name="poll_id" value="${poll.id}" />
											<input type="hidden" name="topic_id" value="${topic.id}" />
											<div class="poll" align="left">
												#foreach($option in $poll.options)
													<input type="radio" name="poll_option" value="${option.id}">${option.text}</input><br/>
												#end
												<input type="submit" class="submit" value="${I18n.getMessage("PostShow.pollVote")}"></input>
												<span class="gensmall" align="center"><a href="/jforum${extension}?module=posts&amp;action=list&amp;topic_id=${topic.id}&amp;viewResults=true", "")}">${I18n.getMessage("PostShow.showPollResults")}</a></span>
											</div>
										</form>
									#else
										<@presentation.renderPoll poll/>
									#end
								</td>
							</tr>
					</table>
				#end
		        #set($canEditCurrentMessage = ($post.canEdit && $topic.status != 1) || $moderatorCanEdit)
		        #if($canEditCurrentMessage)
					<div class="edit_area" id="${post.id}">${post.text}</div>
				#else
					${post.text}
				#end
				<!-- Attachments -->
				#if($post.hasAttachments() && ($canDownloadAttachments || $attachmentsEnabled))
					#parse("/templates/$!{templateName}/inc/topicAttachments.vm")
				#end
			  </DIV>
		  </DIV>
		  </TD></TR>
		  <TR>
		    <TD class=postfooter>
		    	<hr/>
	  			<b>${I18n.getMessage("User.signature")}:</b>
	  			#if($useSignature)
					${user.signature}						
			  	#end
			</TD>
		  </TR>
		  <TR>
		    <TD class=postfooter>
		    #if(($logged || $anonymousPosts) && $topic.status != 1 && !$readonly)
					<form action="/jforum")}" method="post" name="post" id="post" onsubmit="return validatePostForm(this);" enctype="multipart/form-data" accept-charset="${encoding}">
						<input type="hidden" name="action" value="insertSave" />
						<input type="hidden" name="module" value="posts" />
						<input type="hidden" name="forum_id" value="${forum.id}" />
						<input type="hidden" name="start" value="${start}" />
						<input type="hidden" name="topic_id" value="${topic.id}" />
						<input type="hidden" name="disable_html" value="1" />
						<input type="hidden" name="quick" value="1" />
						<div align="center" style="display: none;" name="quickReplyDivTable" id="quickReply${post_index}">
							<table>
								<tr>
									<td align="left" width="70%">
										<input class="post" style="width: 100%" name="message" rows="0" cols="35" onkeyup="enterText(this);" onclick="enterText(this);" onselect="enterText(this);" onblur="leaveText();" type="textbox">
										#if($needCaptcha)
											<br/><span class="gensmall" valign="absmiddle">${I18n.getMessage("User.captchaResponse")}</span>
											<input type="text" style="width: 80px; font-weight: bold;" valign="absmiddle" maxlength="25" name="captcha_anwser" /> 
											<img border="0" align="middle" id="captcha_img${post_index}"/>
											<span class="gensmall" valign="absmiddle">${I18n.getMessage("User.hardCaptchaPart1")} <a href="#newCaptcha" onClick="newCaptcha('${post_index}')"><b>${I18n.getMessage("User.hardCaptchaPart2")}</b></a></span>
										#end
									</td>
								<td align="center" valign="center" width="10%">
										<input type="submit" id="btnSubmit" value="${I18n.getMessage("PostForm.submit")}" class="submit" />
									</td>
								</tr>
							</table>
						</div>
					</form>
				#end
				#parse("/templates/$!{templateName}/inc/topicActionButton.vm")
			</TD>
		  </TR>
		  </TBODY>
	  </TABLE>
</DIV>
#end

<DIV class=pages_btns>
	<div class="pages">
		<a href="/forums/show/${forum.id}")}" class="next"> &lsaquo;&lsaquo; ${forum.name}</a>
	</div>
	${paginationData}
	<SPAN class=postbtn id="newtopic" onmouseover="$('newtopic').id = 'newtopictmp';this.id = 'newtopic';showMenu(this.id);">
		<A href="/jforum${extension}?module=posts&amp;action=insert&amp;forum_id=${forum.id}", "")}">
			<IMG src="${contextPath}/templates/${templateName}/images/newtopic.gif" border=0>
		</A>
	</SPAN>
	#if(!$readonly && $topic.status != 1)
		<SPAN class=replybtn><A href="javascript:replyTopic();">
			<a href="/posts/reply/${start}/${topic.id}")}" rel="nofollow" class="icon_reply nav">
				<IMG alt="Reply" src="${contextPath}/templates/${templateName}/images/reply.gif" border=0>
			</a>
		</SPAN>
	#end
</DIV>
<div id="nav">
	<span class="nav">
	<a class="nav" href="${contextPath}/index.html")}">${I18n.getMessage("ForumListing.forumIndex")} </a> 
	&raquo; <a class="nav" href="${contextPath}/forum-${forum.id}.html")}">${forum.name} </a></span>
	&raquo;<span class="maintitle"><a href="${contextPath}/topic-${topic.id}.html")}" name="top" class="maintitle" id="top">${topic.title}</a></span>
</div>
<a name="quick"></a>

<script type="text/javascript">
$(document).ready(function() {
	limitURLSize();
	#if($moderatorCanEdit || $canEditSomeMessage)
		$(".edit_area").editable("${contextPath}/jforum${extension}?module=ajax&action=savePost", {
			submit: '${I18n.getMessage("Update")}',
			cancel: '${I18n.getMessage("cancel")}',
			type: 'textarea',
			tooltip: '${I18n.getMessage("PostShow.doubleClickEdit")}',
			rows: 15,
			width: '100%',
			event: 'dblclick',
			indicator: "<img src='${contextPath}/templates/${templateName}/images/indicator.gif'>",
			postload: '${contextPath}/jforum${extension}?module=ajax&action=loadPostContents',
			cssclass: 'inlineedit',
			loadtext: '${I18n.getMessage("PostShow.loading")}...',
			beforesubmit: function(submitdata) { 
				#if($moderationLoggingEnabled)
					var message = prompt("${I18n.getMessage("ModerationLog.changeReason")}");

					if (message == null || message == "") {
						alert("${I18n.getMessage("ModerationLog.reasonIsEmpty")}");
						return false;
					}
					else {
						submitdata["log_description"] = message;
						submitdata["log_type"] = 2;
					}
				#end

				return true;
			}
		}, function(s) {
			#if($hasCodeBlock)
				dp.sh.HighlightAll('code');
			#else
				if (s.indexOf("name=\"code\"") > -1) {
					document.location.reload(true);
				}
			#end
		});
	#end
});
</script>
<DIV class=legend id=footfilter>
	<DIV class=jump_sort>
#forumsComboTable()
	</DIV>
</DIV>
#parse("/templates/$!{templateName}/inc/bottom.vm")