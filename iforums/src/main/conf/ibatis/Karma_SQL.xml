<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="Karma">
	<insert id="insert">
		INSERT INTO jforum_karma (post_id, post_user_id, from_user_id, points,
		topic_id, rate_date) VALUES (?, ?, ?, ?, ?, ?)
</insert>
	<update id="update">
		UPDATE jforum_karma SET points = ? WHERE karma_id = ?
</update>
	<select id="getUserKarma">
		SELECT user_karma FROM jforum_users WHERE user_id = ?
</select>
	<update id="updateUserKarma">
		UPDATE jforum_users SET user_karma = ? WHERE user_id = ?
</update>
	<select id="getPostKarma">
		SELECT SUM(points) / COUNT(post_id) AS points FROM jforum_karma WHERE
		post_id = ?
</select>
	<select id="userCanAddKarma" resultClass="java.lang.Integer"
		parameterClass="java.lang.String">
		SELECT COUNT(1) FROM jforum_karma WHERE post_id = ? AND from_user_id = ?
	</select>
	<select id="getUserKarmaPoints">
		SELECT SUM(points) AS points, COUNT(1) AS votes, from_user_id
		FROM jforum_karma WHERE post_user_id = ? GROUP BY from_user_id
	</select>
	<select id="getUserVotes">
		SELECT points, post_id FROM jforum_karma WHERE topic_id = ? AND from_user_id
		= ?	
	</select>
	<select id="getUserGivenVotes">
		SELECT COUNT(post_id) AS votes FROM jforum_karma WHERE from_user_id = ?
	</select>
	<select id="getUserTotalVotes">
		SELECT SUM(points) AS points, COUNT(post_id) AS votes FROM jforum_karma
		WHERE post_user_id = ?
	</select>
	<select id="getMostRatedUserByPeriod">
		SELECT u.user_id, u.username, SUM(points) AS total,
		COUNT(post_user_id) AS votes_received, user_karma,
		-1 AS given
		FROM jforum_users u, jforum_karma k
		WHERE u.user_id = k.post_user_id
		AND k.rate_date BETWEEN ? AND ?
		GROUP BY u.user_id, u.username, user_karma
	</select>
</sqlMap>